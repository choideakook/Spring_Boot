# 동시요청 - 멀티 쓰레드

## ✏️ 서블릿의 호출

클라이언트가 서버로 요청을 할경우 서블릿이 호출된다.
이때 어떤 과정을 거처 서블릿 객체가 호출되는 것일까?

- 바로 쓰레이드 이다.

<img width="550" alt="s8131" src="https://user-images.githubusercontent.com/115536240/218249642-17b7dad1-de74-409d-8326-5f0c8e45b58d.png">

## ✏️ 쓰레드

- application 코드를 하나하나 순차적으로 실행하는 것을 쓰레드라고 한다.
- Java 메인 method 를 처음 실행하면 main 이라는 이름의 쓰레드가 실행된다.
- 만약 쓰레드가 없다면, Java application 실행이 불가능하다.
- 쓰레드는 한번에 하나의 코드 라인만 수행이 가능하다.
- 동시 처리가 필요하면 쓰레드를 추가로 생성해야 한다.

<br>

### 📍 쓰레드의 작동방식

<img width="550" alt="s8132" src="https://user-images.githubusercontent.com/115536240/218249645-b920cc40-8521-4aef-9d70-f27c6c3f5774.png">

1. 요청을 받은 서버는 휴식중인 쓰레드에 할당을한다.
2. 쓰래드는 서블릿을 호출한다.
3. 호출된 서블릿은 쓰레드를 갖은 상태로 코드를 실행한다.
    - 쓰레드가 서블릿 코드를 실행하는 도중에 새로운 요청이 발생할경우 대기해야한다.
    - 쓰레드가 처리하는 요청이 지연된 상태로 대기중인 요청이 많을경우 모든 요청이 타임아웃으로 에러가 발생할 수 있다.
4. 처리가 완료되면 서블릿은 응답값을 return 한다.
5. 임무를 마친 쓰레드는 다시 휴식모드로 전환된다.

### ⚠️ 만약 쓰레드가 서블릿을 호출한 상태에서 다른 요청이 발생한다면

- 휴식중인 쓰레드가 없다면 쓰레드가 휴식모드로 전환될 때 까지 대기한다.
    - 이렇게 되면 클라이언트의 대기시간이 너무 길어질 수 있는 단점이 있다.
- 휴식중인 쓰레드가 없다면 새로운 쓰레드를 생성하는 방법으로 문제를 해결할 수 있다.
    - 사용이 끝난 생성된 쓰레드는 휴식모드가 아닌 삭제로 처리한다.

<img width="550" alt="s8133" src="https://user-images.githubusercontent.com/115536240/218249647-7af4247c-d6f5-463b-ac9b-7320eff7c487.png">

<br>

## ✏️ 요청 마다 쓰레드 생성시 장단점

- 장점
    - 동시 요청을 처리할 수 있다.
    - 리소스 (CPU, 메모리) 가 허용할 때 까지 처리가 가능하다.
    - 하나의 쓰레드가 지연되어도, 나머지 쓰레드는 정상 작동한다.
- 단점
    - 쓰레드의 생성비용이 너무 비싸다.
        - 고객 요청이 올 때 마다 쓰레드를 생성하면 응답속도가 느려짐
    - 쓰레드는 컨텍스트 스위칭 비용이 발생한다.
        - 쓰레드가 아무리 많더라도 코어는 하나만 존재한다.
        - 코어는 여러개의 쓰레드를 처리하기위해 아주 빠른속도로 많은 쓰레드의 업무를 스위칭하며 조금씩 처리하는데 이때 발생하는 비용을 컨텍스트 스위칭 비용 이라고 한다.
    - 쓰레드 생성에 제한이 없다.
        - 고객 요청이 너무 많이올경우 CPU 또는 메모리 임계점이 넘어가면 서버가 다운될 수 있다.

## ✏️ 쓰레드 풀로 단점 보완

<img width="550" alt="s8134" src="https://user-images.githubusercontent.com/115536240/218249648-bf9919e3-e862-4aee-9ca5-e85cd665380c.png">

1. WAS 내에 미리 만든 쓰레드 풀에 쓰레드들을 휴식상태로 생성해 놓는다.
    - 예시에서는 200 개의 쓰레드 풀이 준비되어있음
2. 클라이언트의 요청이 발생되면 쓰레드 풀에서 쓰레드를 꺼내 할당한다.
3. 사용이 완료된 쓰레드는 삭제가 아닌 다시 쓰레드 풀에 휴식상태로 넣어둔다.
4. 만약 쓰래드가 전부 사용중인 상태에서 요청이 추가로 발생될경우 WAS 는 쓰레드를 대기 시키거나, 거절 할 수 있다.

<br>

### 📍 쓰레드 풀 정리

- 특징
    - 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.
    - 쓰레드 풀에 생성 가능한 최대치를 관리하기 때문에 임계점이 넘어가지 않는다.
        - 톰캣은 200 개로 기본 설정된다.
        - 개발자가 Max Thread 를 설정할 수 있음
- 사용
    - 쓰레드가 필요하면 이미 생성된 쓰레드를 풀에서 꺼내 사용한다.
    - 사용이 끝난 쓰레드는 쓰레드 풀에 반납된다.
    - 쓰레드가 부족할경우 요청을 거절하거나, 대기하도록 설정할 수 있다.
- 장점
    - 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용 (CPU) 이 절약된다.
        - 응답 시간이 빨라짐
    - 생성 가능한 쓰레드의 최대치가 있으므로 많은 요청이 들어와도 안전하게 처리할 수 있다.
        - 서버는 안전하게 작동되지만 클라이언트는 기다려야한다.
        - 이 경우 서버를 늘리는 방법으로 해결할 수 있다.

<br>

### 📍 쓰레드 풀 사용 실무 팁

- WAS 의 주요 튜닝 포인트는 최대 쓰레드 (Max Thread) 를 알맞게 조절하는 것 이다.
    - 값을 너무 낮게 설정할 경우,
    동시 요청이 많으면 서버 리소스는 여유롭지만, 클라이언트의 응답은 너무 지연된다.
    - 값을 너무 높게 설정할 경우,
    동시 요청이 많으면 CPU, 메모리 리소스의 임계점 초과로 서버가 다운될 수 있다.
        - 서버가 다운되면 복구하기가 쉽지 않다.
    - 장애가 발생할경우,
        - 클라우드면 일단 서버부터 늘린후에 튜닝
        - 클라우드가 아니면 틈틈히 튜닝
- 쓰레드 풀의 적정 숫자를 찾으려면
    - Max Tread 의 숫자는 application 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다르다.
    - 최대한 실제 서비스와 유사하게 성능 테스트를 시도해 상황에 맞는 판단을 해야한다.
        - 성능 테스트 툴 : 아파치 ab, 제이미터, nGrinder …

<br>

## ✏️ WAS 의 멀티 쓰레드 지원

- 멀티 쓰레드에 대한 부분은 WAS 가 처리할 수 있게 맡긴다.
    - 개발자는 멀티 쓰레드 관련 코드를 신경쓰지 않아도 됨
- 개발자는 마치 싱글 쓰레드 프로그래밍을 하듯이 소스 코드를 개발한다.

### ⚠️ 멀티 쓰레드 환경이므로 싱글톤 객체 (서블릿, 스프링 빈) 는 주의해서 사용해야 한다.

다앙한 쓰레드를 통해 싱글톤에 동시에 접근될 경우 공유변수 문제가 발생할 수 있음

- 로그인을 했는데 다른 사람의 계정으로 로그인이 됨
