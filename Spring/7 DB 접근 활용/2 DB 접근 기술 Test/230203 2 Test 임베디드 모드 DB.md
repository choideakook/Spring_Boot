# Test 임베디드 모드 DB

## ✏️ 임베디드 모드 DB

### 📍 필요성

Test 를 실행하기 위해서 별도의 DB 를 운영하는것은 매우 번거로운 일이다.

단순하게 test 를 사용할 목적으로 DB 가 필요하기 때문에 Test 가 끝나면 DB 를 제거해도 무방하다.

### 📍 임베디드 모드로 문제 해결

⚠️ 임베디드 모드란

H2 DB 는 java 로 개발되었고, JVM 안에서 메모리 모드로 동작하는 기능을 재공한다.

따라서 application 이 실행될 때 H2 DB 도 JVM 메모리에 포함해서 함께 실행할 수 있다.

즉 DB 가 application 에 내장되어 실행되고 이를 임베디드 모드 (Embedded mode) 라고 한다.

- application 이 종료되면 H2 DB 도 함께 종료되고 data 도 모두 사라진다.

<br>

- 임베디드 모드 환경설정

```java
package hello.itemservice;

import hello.itemservice.config.*;
import hello.itemservice.repository.ItemRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Profile;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import javax.sql.DataSource;

@Slf4j
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	@Bean
	@Profile("local")
	public TestDataInit testDataInit(ItemRepository itemRepository) {
		return new TestDataInit(itemRepository);
	}

	@Bean 
  // test 실행시 실행되는 로직
  // profiles - active 에서 설정을 변경해 주어야 한다.
	@Profile("test") 
	public DataSource dataSource() {
		log.info("메모리 데이터베이스 초기화");
		// test 를 실행할 땐 Data Source (드라이버) 를 수동으로 지정하는 로직
		DriverManagerDataSource dataSource = new DriverManagerDataSource();
		// H2 DB 드라이버를 직접 지정
		dataSource.setDriverClassName("org.h2.Driver");
		// test 를 사용할 때 사용하는 db connection
		// mem 로 설정하면 메모리 모드 라는 뜻이다.
		dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
		dataSource.setUsername("sa");
		dataSource.setPassword("");
		return dataSource;
	}
}
```

<br>

- application.yml 환경설정

```java
spring:
  profiles:
    active: test // active 에 profiles 이 입력된 method 만 작동이 된다.
```

❗이대로 실행하면 Memory DB 에 Table 이 없어서 예외가 발생하게 된다.

- 수동으로 Table 을 생성할 수 있지만 application 이 종료될 때 table 도 종료되기 때문에 번거로운 작업이 된다.

<br>

### 📍 기본 SQL 스크립트로 Table 을 생성해 문제 해결

Spring Boot 가 제공하는 기본 SQL 스크립트를 실행해 applcation 로딩 시점에 DB 를 초기화 하는 기능을 사용한다.

test - resources 에 schema.sql file 을 생성하고 SQL 문을 작성해준다.

- application 로딩 시점에 해당 SQL 문을 먼저 실행해 Table 을 생성해 놓는다.
- schema.sql 파일명이 다르면 인식이 안되니 주의
- 메모리를 사용한 DB 기 때문에 H2 콘솔과 연결이 끊겨도 사용 가능하다.

```sql
drop table if exists item CASCADE;
create table item
(
    id        bigint generated by default as identity,
    item_name varchar(10),
    price     integer,
    quantity  integer,
    primary key (id)
);
```

<br>

## ✏️ Spring boot 와 임베디드 모드

이 전의 방식으로 임베디드 모드 DB 를 운영할 수 있지만 직접 Test 용  프로필 method 를 만들어야 하는 번거로움이 있지만

Spring boot 가 제공하는 임베디드 DB 를 사용하면 이러한 문제점을 해결할 수 있다.

### 📍 프로필 제거

Spring boot 가 제공하는 임베디드 DB 를 사용하면 프로필을 따로 작성하지 않아도 된다.

```java
package hello.itemservice;

import hello.itemservice.config.*;
import hello.itemservice.repository.ItemRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Profile;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import javax.sql.DataSource;

@Slf4j
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	@Bean
	@Profile("local")
	public TestDataInit testDataInit(ItemRepository itemRepository) {
		return new TestDataInit(itemRepository);
	}

//	@Bean
//	@Profile("test")
//	public DataSource dataSource() {
//		log.info("메모리 데이터베이스 초기화");
//		DriverManagerDataSource dataSource = new DriverManagerDataSource();
//		dataSource.setDriverClassName("org.h2.Driver");
//		dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
//		dataSource.setUsername("sa");
//		dataSource.setPassword("");
//		return dataSource;
//	}
}
```

<br>

### 📍 Test application 환경설정

H2 DB 관련 환경설정을 모두 제거한다.

- DB 에 접근하는 모든 설정정보가 사라진다.
- 별다른 정보가 없을경우 Spring boot 는 임베디드 모드로 접근하는 Data Source 를 만들어 제공하게 된다.

```yaml
spring:
  profiles:
    active: test

#  datasource:
#    url: jdbc:h2:tcp://localhost/~/testcase
#    username: sa
#    password:
#    driver-class-name: org.h2.Driver

logging:
  level:
    org.hibernate.SQL: debug
```

DB 에 연결하지 않아도 정상적으로 Test 가 완료된다.

❗ Table 을 생성하는 schema.sql 은 삭제하면 안된다.